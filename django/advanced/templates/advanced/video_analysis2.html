{% extends 'advanced/base.html' %}
{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Video Analysis</h5>
                <div class="form-group mb-3">
                    <div class="input-group">
                        <input type="text" id="video-url" class="form-control" placeholder="Enter YouTube URL (e.g., https://youtube.com/watch?v=...)">
                        <button id="analyze-btn" class="btn btn-primary">
                            <span id="analyze-text">Analyze Comments</span>
                            <span id="loading-spinner" class="spinner-border spinner-border-sm d-none"></span>
                        </button>
                    </div>
                    <small class="form-text text-muted">Paste a YouTube video URL to analyze its comments</small>
                </div>
            </div>
        </div>
        <div id="video-container" class="mt-4 ratio ratio-16x9"></div>
        <!-- Monitoring Section -->
        <div class="card mt-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Video Monitoring</h5>
                <button id="start-monitoring" class="btn btn-success me-2">Start Monitoring</button>
                <button id="stop-monitoring" class="btn btn-danger" disabled>Stop Monitoring</button>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm sticky-top" style="top: 1rem;">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Detected Hate Comments</h5>
            </div>
            <div class="card-body p-0">
                <div id="results-container" class="results-scroll"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentVideoId = null;

document.getElementById('analyze-btn').addEventListener('click', analyzeVideo);
document.getElementById('start-monitoring').addEventListener('click', startMonitoring);
document.getElementById('stop-monitoring').addEventListener('click', stopMonitoring);

async function analyzeVideo() {
    const button = document.getElementById('analyze-btn');
    const spinner = document.getElementById('loading-spinner');
    const analyzeText = document.getElementById('analyze-text');
    const videoUrl = document.getElementById('video-url').value.trim();

    if (!validateYouTubeUrl(videoUrl)) {
        alert('Please enter a valid YouTube URL');
        return;
    }

    try {
        button.disabled = true;
        spinner.classList.remove('d-none');
        analyzeText.textContent = 'Analyzing...';

        const videoId = extractVideoId(videoUrl);
        if (!videoId) {
            throw new Error('Could not extract video ID');
        }

        updateVideoPlayer(videoId);
        currentVideoId = videoId;

        const response = await fetch('/analyze/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ video_url: videoUrl })
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error || 'Error analyzing video');
        }

        updateResults(data.results);
        alert('Analysis completed successfully');
    } catch (error) {
        console.error('Error:', error);
        alert(error.message || 'An error occurred');
    } finally {
        button.disabled = false;
        spinner.classList.add('d-none');
        analyzeText.textContent = 'Analyze Comments';
    }
}

function updateResults(results) {
    const container = document.getElementById('results-container');
    container.innerHTML = results.length === 0 
        ? '<div class="alert alert-info m-3">No hate comments detected.</div>'
        : results.filter(r => r.is_toxic).map(result => `
            <div class="comment-item p-3 border-bottom">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="comment-text flex-grow-1">
                        <p class="mb-0">${result.text}</p>
                    </div>
                    <span class="badge bg-danger ms-2">
                        ${(result.probability * 100).toFixed(1)}%
                    </span>
                </div>
            </div>
        `).join('');
}

function startMonitoring() {
    if (!currentVideoId) {
        alert('Please analyze a video first');
        return;
    }
    document.getElementById('start-monitoring').disabled = true;
    document.getElementById('stop-monitoring').disabled = false;
    // Aquí iría la lógica para iniciar el monitoreo
}

function stopMonitoring() {
    document.getElementById('start-monitoring').disabled = false;
    document.getElementById('stop-monitoring').disabled = true;
    // Aquí iría la lógica para detener el monitoreo
}

// ... (resto de funciones auxiliares como validateYouTubeUrl, extractVideoId, updateVideoPlayer, getCookie)

</script>
{% endblock %}