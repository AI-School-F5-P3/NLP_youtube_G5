{% extends 'advanced/base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Video Analysis</h5>
                <div class="form-group mb-3">
                    <input type="text" id="video-url" class="form-control" placeholder="Enter YouTube URL">
                </div>
                <button id="analyze-btn" class="btn btn-primary">
                    <span id="analyze-text">Analyze Comments</span>
                    <span id="loading-spinner" class="spinner-border spinner-border-sm d-none"></span>
                </button>
            </div>
        </div>
        
        <div id="video-container" class="mt-4"></div>
        
        <!-- Sección de monitoreo -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Real-Time Analysis Control</h5>
                <div class="d-flex justify-content-center">
                    <button id="start-analysis" class="btn btn-success mx-2" onclick="startMonitoring('{{ video.video_id }}')">
                        Start
                    </button>
                    <button id="stop-analysis" class="btn btn-danger mx-2" onclick="manageTask('{{ video.video_id }}', 'stop')">
                        Stop
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Detected Hate Comments</h5>
                <div id="results-container" class="results-scroll">
                    {% for comment in comments %}
                    <div class="comment-item mb-3 p-2 border rounded">
                        <p>{{ comment.text }}</p>
                        <p class="text-end">Probability: {{ comment.probability|floatformat:2 }}%</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Función para actualizar el contenedor del video
function updateVideoContainer(videoId) {
    document.getElementById('video-container').innerHTML = `
        <iframe width="100%" height="315" 
                src="https://www.youtube.com/embed/${videoId}" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen></iframe>
    `;
}

// Función para analizar el video
async function analyzeVideo(videoUrl) {
    const response = await fetch('/analyze/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ video_url: videoUrl })
    });
    
    if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'Error analyzing video');
    }
    
    return await response.json();
}

// Función para actualizar resultados
function updateResults(results, action = 'replace') {
    const resultsContainer = document.getElementById('results-container');
    
    if (action === 'replace') {
        resultsContainer.innerHTML = '';
    }
    
    if (!results || results.length === 0) {
        if (action === 'replace') {
            resultsContainer.innerHTML = '<div class="alert alert-info">No hate comments detected.</div>';
        }
        return;
    }
    
    results.forEach(result => {
        if (result.is_toxic) {
            const commentElement = document.createElement('div');
            commentElement.className = 'alert alert-danger d-flex justify-content-between align-items-center';
            commentElement.innerHTML = `
                <div class="flex-grow-1">
                    <small>${result.text}</small>
                </div>
                <div class="badge bg-danger ml-2">
                    ${(result.probability * 100).toFixed(1)}%
                </div>
            `;
            resultsContainer.prepend(commentElement);  // Añadir al principio
        }
    });
}

// Función auxiliar para extraer el video ID
function extractVideoId(url) {
    try {
        const urlObj = new URL(url);
        if (urlObj.hostname.includes('youtube.com')) {
            return urlObj.searchParams.get('v') || '';
        } else if (urlObj.hostname.includes('youtu.be')) {
            return urlObj.pathname.substring(1);
        }
        return '';
    } catch (e) {
        console.error('Error parsing URL:', e);
        return '';
    }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    const analyzeBtn = document.getElementById('analyze-btn');
    const startButton = document.getElementById('start-analysis');
    const stopButton = document.getElementById('stop-analysis');
    
    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', async () => {
            const button = analyzeBtn;
            const spinner = document.getElementById('loading-spinner');
            const analyzeText = document.getElementById('analyze-text');
            const videoUrl = document.getElementById('video-url').value;
            
            if (!videoUrl) {
                alert('Please enter a valid YouTube URL');
                return;
            }

            try {
                button.disabled = true;
                spinner.classList.remove('d-none');
                analyzeText.textContent = 'Analyzing...';

                const videoId = extractVideoId(videoUrl);
                if (!videoId) {
                    throw new Error('Invalid YouTube URL');
                }
                
                updateVideoContainer(videoId);
                const data = await analyzeVideo(videoUrl);
                updateResults(data.results);

            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'An error occurred while analyzing the video');
            } finally {
                button.disabled = false;
                spinner.classList.add('d-none');
                analyzeText.textContent = 'Analyze Comments';
            }
        });
    }
    
    if (startButton) {
        startButton.addEventListener('click', startMonitoring);
    }
    
    if (stopButton) {
        stopButton.addEventListener('click', stopMonitoring);
    }
});

// Funciones para el monitoreo en tiempo real
async function startMonitoring() {
    const startButton = document.getElementById('start-analysis');
    const stopButton = document.getElementById('stop-analysis');
    const videoUrl = document.getElementById('video-url').value;
    
    const videoId = extractVideoId(videoUrl);
    if (!videoId) {
        alert('Please enter a valid YouTube URL');
        return;
    }

    try {
        startButton.disabled = true;
        
        const response = await fetch('/start-monitoring/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ video_id: videoId })
        });

        if (!response.ok) {
            throw new Error('Failed to start monitoring');
        }

        const data = await response.json();
        window.currentTaskId = data.task_id;
        
        // Cerrar EventSource existente si hay uno
        if (window.currentEventSource) {
            window.currentEventSource.close();
        }
        
        // Crear nuevo EventSource
        window.currentEventSource = new EventSource(`/monitor/${videoId}/`);
        
        // Manejar eventos
        window.currentEventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.error) {
                    console.error('Server error:', data.error);
                    return;
                }
                updateResults(data.results, data.action || 'replace');
            } catch (error) {
                console.error('Error processing SSE message:', error);
            }
        };

        window.currentEventSource.onerror = function(error) {
            console.error('SSE Error:', error);
            if (window.currentEventSource) {
                window.currentEventSource.close();
            }
        };

        startButton.classList.add('d-none');
        stopButton.classList.remove('d-none');
        
    } catch (error) {
        console.error('Error:', error);
        alert(error.message || 'An error occurred while starting monitoring');
    } finally {
        startButton.disabled = false;
    }
}

async function stopMonitoring() {
    const startButton = document.getElementById('start-analysis');
    const stopButton = document.getElementById('stop-analysis');
    const videoUrl = document.getElementById('video-url').value;
    const videoId = extractVideoId(videoUrl);

    if (!videoId || !window.currentTaskId) {
        alert('No active monitoring session found');
        return;
    }

    try {
        stopButton.disabled = true;

        if (window.currentEventSource) {
            window.currentEventSource.close();
        }

        const response = await fetch('/stop-monitoring/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                video_id: videoId,
                task_id: window.currentTaskId
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to stop monitoring');
        }

        window.currentTaskId = null;
        stopButton.classList.add('d-none');
        startButton.classList.remove('d-none');

    } catch (error) {
        console.error('Error:', error);
        alert(error.message || 'An error occurred while stopping monitoring');
    } finally {
        stopButton.disabled = false;
    }
}

// Función para obtener el token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.results-scroll {
    max-height: 500px;
    overflow-y: auto;
}

.video-item {
    background-color: #f8f9fa;
}

.video-item:hover {
    background-color: #e9ecef;
}
</style>
{% endblock %}
