{% extends 'advanced/base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Video Analysis</h5>
                <div class="form-group mb-3">
                    <input type="text" id="video-url" class="form-control" placeholder="Enter YouTube URL">
                </div>
                <button id="analyze-btn" class="btn btn-primary">
                    <span id="analyze-text">Analyze Comments</span>
                    <span id="loading-spinner" class="spinner-border spinner-border-sm d-none"></span>
                </button>
            </div>
        </div>
        
        <div id="video-container" class="mt-4"></div>
        
        <!-- SecciÃ³n de monitoreo -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Video Monitoring</h5>
                <div class="video-list">
                    {% for video in videos %}
                    <div class="video-item mb-3 p-3 border rounded">
                        <h6>{{ video.url }}</h6>
                        <div class="btn-group">
                            <button class="btn btn-success btn-sm" onclick="startMonitoring('{{ video.video_id }}')">
                                Start Monitoring
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="manageTask('{{ video.video_id }}', 'stop')">
                                Stop Monitoring
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Detected Hate Comments</h5>
                <div id="results-container" class="results-scroll"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('analyze-btn').addEventListener('click', async () => {
    const button = document.getElementById('analyze-btn');
    const spinner = document.getElementById('loading-spinner');
    const analyzeText = document.getElementById('analyze-text');
    const videoUrl = document.getElementById('video-url').value;
    
    if (!videoUrl) {
        alert('Please enter a valid YouTube URL');
        return;
    }

    try {
        button.disabled = true;
        spinner.classList.remove('d-none');
        analyzeText.textContent = 'Analyzing...';

        let videoId;
        try {
            const url = new URL(videoUrl);
            videoId = url.searchParams.get('v');
            if (!videoId) {
                throw new Error('Invalid YouTube URL');
            }
        } catch (e) {
            alert('Please enter a valid YouTube URL');
            return;
        }
        
        document.getElementById('video-container').innerHTML = `
            <iframe width="100%" height="315" 
                    src="https://www.youtube.com/embed/${videoId}" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen></iframe>
        `;
        
        const response = await fetch('/analyze/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ video_url: videoUrl })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Error analyzing video');
        }
        
        updateResults(data.results);
    } catch (error) {
        console.error('Error:', error);
        alert(error.message || 'An error occurred while analyzing the video');
    } finally {
        button.disabled = false;
        spinner.classList.add('d-none');
        analyzeText.textContent = 'Analyze Comments';
    }
});

function updateResults(results) {
    const resultsContainer = document.getElementById('results-container');
    resultsContainer.innerHTML = '';
    
    if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="alert alert-info">No hate comments detected.</div>';
        return;
    }
    
    results.forEach(result => {
        if (result.is_toxic) {
            resultsContainer.innerHTML += `
                <div class="alert alert-danger d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <small>${result.text}</small>
                    </div>
                    <div class="badge bg-danger ml-2">
                        ${(result.probability * 100).toFixed(1)}%
                    </div>
                </div>
            `;
        }
    });
}

function startMonitoring(videoId) {
    const eventSource = new EventSource(`/monitor/${videoId}/`);
    
    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        updateResults(data.results);
    };
    
    eventSource.onerror = function() {
        eventSource.close();
    };
}

async function manageTask(videoId, action) {
    try {
        const response = await fetch('/manage-task/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ video_id: videoId, action: action })
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error || 'Error managing task');
        }
        
        alert(data.status);
        
        if (action === 'start' || action === 'stop') {
            location.reload();
        }
    } catch (error) {
        console.error('Error managing task:', error);
        alert(error.message || 'An error occurred while managing the task');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.results-scroll {
    max-height: 500px;
    overflow-y: auto;
}

.video-item {
    background-color: #f8f9fa;
}

.video-item:hover {
    background-color: #e9ecef;
}
</style>
{% endblock %}
